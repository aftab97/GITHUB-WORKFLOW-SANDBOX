name: Create Release Pull Request (main -> master) / Prod

on:
  push:
    branches:
      - 'main'

permissions:
  id-token: write
  contents: write
  actions: write
  pull-requests: write

jobs:
  pull:
    name: 'ğŸš€ Prod Release PR'
    runs-on: ubuntu-latest

    steps:
      - name: 'ğŸ“¥ Check-out'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'ğŸ›ï¸ Set Node Version'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: 'ğŸ“œ Get Diff Log'
        id: log
        run: |
          echo "log="[$(git log origin/master..origin/main --oneline --pretty=format:'{"subject": "%f"},')]"" >> $GITHUB_OUTPUT

      - name: 'ğŸ’» Install and Build Changelog Action'
        run: npm install && npm run build
        working-directory: ./packages/tools/changelog

      - name: 'ğŸ“š Generate NEO Changelog'
        id: get-fusion-changelog
        uses: ./packages/tools/changelog
        with:
          log: ${{ steps.log.outputs.log }}
          token: ${{ secrets.PAT }}
        env:
          GH_TOKEN: ${{ secrets.PAT }}

      - name: 'ğŸ› Debug Diff Log'
        run: |
          echo "LOG OUTPUT:"
          echo "${{ steps.log.outputs.log }}"
          echo "LOG2 OUTPUT:"
          echo "${{ steps.get-fusion-changelog.outputs.changelog }}"

      - name: 'ğŸ’» Install and Build Feature Branch Check Action'
        run: npm install && npm run build
        working-directory: ./packages/tools/feature-branch-check

      - name: 'ğŸ‘ PR Check'
        id: pr-check
        uses: ./packages/tools/feature-branch-check
        with:
          branch: 'main'
          token: ${{ secrets.PAT }}

      - name: 'ğŸ“ Generate PR Body'
        id: pr_body
        run: |
          cat <<EOF > pr_body.md
          #### What changes does this PR bring?
          <br />

          ${{ steps.get-fusion-changelog.outputs.changelog }}

          #### Browser Checks

          If you do not have access to any of the browsers below, please use Browserstack.

          ##### Must:

          - [ ] Have you checked the branch in the latest version of Google Chrome?
          - [ ] Have you checked the branch in the latest version of Firefox?
          - [ ] Have you checked the branch in the latest version of Safari?
          - [ ] Have you checked the branch in the latest version of Edge?

          #### Testing

          ##### Staging

          [TBA](TBA)

          ##### Production

          [TBA](TBA)

          ##### EU

          [TBA](TBA)

          ##### AU

          [TBA](TBA)

          #### Types of review(s) required?

          Regression
          EOF

      - name: 'ğŸ“ Create Pull Request (if needed)'
        id: create_pr
        if: ${{ steps.pr-check.outputs.create_pr == 'true' }}
        continue-on-error: true
        run: |
          pr_url=$(gh pr create \
            --base master \
            --head main \
            --title "(PROD) Release (test)" \
            --body-file pr_body.md)

          echo "pr_url=$pr_url" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.PAT }}

      - name: 'ğŸ” Find Existing PR (if create failed)'
        id: find_existing
        if: ${{ steps.create_pr.outputs.pr_url == '' }}
        run: |
          existing_pr=$(gh pr list --base main --head sit --json url --jq '.[0].url')
          echo "pr_url=$existing_pr" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.PAT }}

      - name: 'ğŸ” Use PR URL'
        id: ensure_pr_url
        run: |
          echo "pr_url=${{ steps.create_pr.outputs.pr_url || steps.find_existing.outputs.pr_url }}" >> $GITHUB_OUTPUT

      # - name: 'ğŸ“ Update Pull Request Description'
      #   run: |
      #     gh pr edit "${{ steps.ensure_pr_url.outputs.pr_url }}" --body-file pr_body.md
      #   env:
      #     GH_TOKEN: ${{ secrets.PAT }}
